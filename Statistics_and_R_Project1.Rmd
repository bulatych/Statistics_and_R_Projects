---
title: "Statistics_and_R_Project_1"
author: "Firtst_author"
date: "2024-10-11"
output:
  html_document:
    css: styles.css
    latex_engine: xelatex
    theme: cosmo
    toc_depth: 4
  pdf_document: default
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Анализ датасета сервиса проката велосипедов и самокатов

Наша команда представляет отчет по анализу данных из датасета day.csv. Этот датасет содержит информацию о сервисе проката велосипедов и самокатов, арендованных за 2011-2012 года в Вашингтоне. Данные собирались в течение 731 дня и включают 17 колонок с различными переменными.

### Переменные датасета

-   **instant**: ID наблюдения

-   **dteday**: дата поездки

-   **season**: информация о сезонах (1: зима, 2: весна, 3: лето, 4: осень)

-   **yr**: год (0: 2011, 1: 2012)

-   **mnth**: месяц проката

-   **holiday**: поездка в праздничный или обычный день

-   **weekday**: день недели (1: понедельник, 2: вторник, 3: среда, 4: четверг, 5: пятница, 6: суббота, 7: воскресенье)

-   **workingday**: 1 - рабочий день, 0 - выходной день

-   **weathersit**: погода в конкретный день

    -   1: Ясно, немного облаков, частично облачно
    -   2: Туман + облачность, Туман + разорванные облака, Туман + немного облаков, Туман
    -   3: Небольшой снег, небольшой доджь + гроща + рассеянные облака, небольшой дождь, рассеянные облака
    -   4: Проливной дождь + ледянные паллеты + гроза + туман, снег + туман

-   **temp**: Нормированная температура в градусах Цельсиях. Значения делятся на максимальное значение (50)

-   **atemp**: Нормированная температура ощущений в градусах Цельсия. Значения делятся на 50.

-   **hum**: Нормированная влажность. Значения делятся на максимальное значение (100)

-   **windspeed**: Нормированная скорость ветра. Значения делятся на максимальное значение (67)

-   **casual**: количество случайных пользователей

-   **registered**: количество зарегестрированных пользователей

-   **cnt**: общее количество велосипедов, взятых на прокат (случайные + зарегестрированные)

## EDA (Exploratory data analysis)

Сперва взглянем глазами на данные, с которыми нам предстоит работать. Первый этап представляет собой предварительный анализ полученного датасета. Посмотрим, какие у нас переменные, сколько у нас наблюдений и есть ли между ними взаимосвязь. Также на данном этапе необходимо установить, есть ли в датасете пропущенные значения, обнаружить наличие или отсутствие выбросов, а также определить, что делать с наблюдениями, которые их содержат.

Основные задачи:

1)  Понимание структуры данных (сколько, какой тип, дубликаты, пропущенные и тд)

2)  Выявление выбросов

3)  Определение связей между переменными

4)  Подготовка данных для дальнейшего анализа

### Обзор данных и работа с пропущенными значениями

```{r libraries, message=FALSE, echo=TRUE}
library(dplyr) 
library(ggplot2) 
library(tidyverse) 
library(psych)
library(pheatmap)
main_dir <- dirname(rstudioapi::getSourceEditorContext()$path) 
setwd(main_dir)
```

```{r,  message=FALSE, echo=TRUE}
data_day <- read.csv("day.csv") 
str(data_day)
summary(data_day)

```

Как можно заметить, в наших данных присутствуют NA значения, а именно в переменных temp, hum, windspeed, registered Также необходимо проверить, есть ли значения с пустыми строками:

```{r, echo=TRUE}
data_day$dteday <- as.Date(data_day$dteday) # Преобразуем переменную dteday из character в класс Date
data_day_na <- data_day %>% 
  mutate(across(where(~ !is.Date(.)), ~ ifelse(. == "", NA, .)))
```

Таким образом количество NA не увеличилось, что говорит об отсутствии пустых ячеек "". Можем взглянуть на строки с NA

```{r, echo=TRUE}
 data_day_na[!complete.cases(data_day),]
```

Поскольку в нашем датасете достаточно данных, то можем удалить все наблюдения с пропущенными значения (NA).

```{r, echo=TRUE}
bicycle_rent_clean <- na.omit(data_day_na)
```

После удаления NA значений преобразуем наш датасет в более читаемый вид, переименовав некоторые значения переменных. Для удобства в переменной `yr` заменим 0 на 2011 и 1 на 2012 соотвественно.

```{r, echo=TRUE}
bicycle_rent_clean_fix <-  bicycle_rent_clean %>% mutate(yr = case_when(
  yr == 0 ~ 2011,
  yr == 1 ~ 2012,
  TRUE ~ as.numeric(yr)))
```

### Работа с выбросами

На данном этапе попробуем построить различные графики, которые позволяют обнаружить подозрительные значения, похожие на выбросы. Сперва посмотри на месяц и сезоны.

```{r, echo=TRUE}
ggplot(bicycle_rent_clean_fix, aes(x = season, y =mnth))+
  geom_point()
filter(bicycle_rent_clean_fix, season==1 & instant > 600)
```

Может показаться, что верхняя точка является выбросом, но это не так, поскольку 12 месяц также относится к зиме

Попробуем другой график для `atemp` и `season`

```{r, echo=TRUE}
ggplot(bicycle_rent_clean_fix, aes(x = as.factor(season), y = atemp, fill = as.factor(season))) +
  geom_violin(trim = FALSE) +
  geom_jitter(width = 0.2, alpha = 0.3, color = "black") +  # Добавим рассеянные точки для каждого значения
  labs(x = "Сезон", y = "Температура ощущений", fill = "Сезон") +
  ggtitle("Температура ощущений в заивисимости от сезона")
```

**Violin Plot** показывает распределение данных для каждого сезона с помощью формы графика плотности. С помощью `geom_jitter` нанесли все наблюдения на график. Можно заметить, что есть подозрительное значение `atemp` в один из дней лета. Выведем это значение.

```{r, echo=TRUE}
filter(bicycle_rent_clean_fix, season==3 & atemp < 0.4) 
```

Действительно, можем обнаружить, что это летний день, погода ясная, температура составляет 29.6 градусов Цельсия. Однако температура ощущений всего 12.1. Температура должна коррелировать с температурой ощущений, что можно увидеть на графике.

```{r, echo=TRUE}
ggplot(bicycle_rent_clean_fix, aes(x = temp, y = atemp)) +
  geom_point(alpha = 0.6, color = "blue") + 
  geom_smooth(method = "lm", formula = y ~ x, color = "red", se = FALSE) +  # Линия тренда
  labs(x = "Температура(нормированная)", y = "Температура ощущений(нормированная)") +
  ggtitle("Взаимосвязь между температурой и температурой ощущений")
```

Несложно заметить, что одно из значений явно выбивается. Это как раз наш летний день с температурой ощущения 12.1 градусов Цельсия. Исключаем его.

```{r, echo=TRUE}
bicycle_rent_clean_fix_f1 <- filter(bicycle_rent_clean_fix, !(season == '3' & atemp < 0.4))
```

Теперь посмотрим на наши парные графики с распределением для числовых величин.

```{r}
#install.packages("GGally")
library(GGally)

# Создание парных графиков
ggpairs(bicycle_rent_clean_fix_f1 %>% select(temp, atemp, hum, windspeed, casual, registered, cnt), 
        title = "Парные графики")
```

Теперь взглянем на зависимость влажности от месяца

```{r, echo =TRUE}
ggplot(bicycle_rent_clean_fix_f1, aes(x = factor(mnth), y = hum)) +
  geom_boxplot(aes(fill = factor(season))) +
  labs(x = "Month", y = "Humidity", fill = "Season") +
  facet_grid(. ~ season, scales = "free_x", space = "free_x") 
bicycle_rent_clean_fix_f2 <- filter(bicycle_rent_clean_fix_f1, !( mnth == 3 & hum < 0.1))
```

В третьем месяце видим значение влажности равное 0, что очевидно является выбросом. Чтобы решить, что делать со значениями, которые выходят за 1,5 межквартильных размаха, взглянем на другие переменные в датасете.

```{r, echo=TRUE}
filtered_data <- bicycle_rent_clean_fix_f2 %>%
  filter((mnth == 2 & hum < 0.25) |
         (mnth == 3 & hum > 0.92) |
         (mnth == 5 & hum < 0.4)  |
         (mnth == 11 & hum > 0.95))
filtered_data
```

Из полученных данных видно, что высокие значения влажности согласуются с погодой: в данные дни были проливные дожди, грозы, небольшой снег. В двух других наблюдениях низкая влажность может быть обусловлена тем, что в эти дни не было осадков, тумана. Кроме того, это зимний и весенний день, когда влажность обычно ниже, чем летом из-за более низких температур. Также в контексте погоды/влажности/осадков совершенно нормально, если встречаются какие-то аномалии, поскольку иногда случаются дни с нехарактерными погодными условиями в разные сезоны. Поэтому допустим, что такие значения могли быть получены и оставим их.

### Поиск взаимосвязей

Мы исключили выбросы и пропущенные значения и теперь перейдем к выявлению взаимосвязи между переменными. Для этого оставим только числовые переменные.

```{r, echo=TRUE}
bicycle_numeric_data <- bicycle_rent_clean_fix_f2 %>%
  select_if(is.numeric)
```

Для выявления взаимосвязи посмотрим наличие корреляции с помощью библиотеки `psych`

```{r, echo=TRUE}
corr.test(bicycle_numeric_data)
```

Однако для более лучшей наглядности воспользуемся библиотекой `pheatmap`. Данная библиотека позволяет построить тепловую карту для наших данных. Она более удобна в сравнении с функций `melt` из пакета `ggplot2` и не требует преобразования матрицы в подходящий формат.

```{r, echo=TRUE}
library(pheatmap)
corr_matrix <- corr.test(bicycle_numeric_data)$r
pheatmap(corr_matrix, 
         color = colorRampPalette(c("blue", "white", "red"))(50), 
         display_numbers = TRUE)
```

Таким образом, можно наблюдать корреляцию между некоторыми переменнами. Например, температура и температура ощущений, что было продемонстрировано ранее. Также есть сильная взаимосвязь между количеством зарегистрированных пользователей и общим количеством прокатов и чуть более слабая между обычными пользователями и общим количеством прокатов. Также есть некоторая корреляция между количеством пользователей и температурой, погодой и влажностью. Также есть средняя отрицательная корреляция между количеством незарегестрированных пользователей и выходным/рабочим днем.

### Проверка гипотез

Мы проанализировали датасет. Температура`temp` и количество пользователей `cnt`показали довольно сильную корреляцию.

1)  Давайте проверим гипотезу о том, что есть статистически значимая зависимость между данными переменными.

    1)  Нулевая гипотеза: Температура и количество пользователей независимы. Альтернативная гипотеза: Температура и количество пользователей зависят друг от друга.

    2)  Зафиксируем уровень значимости - 0.05

    3)  Используем коэффициент корреляции Пирсона

    4)  Получаем значение статистики и p-value

```{r, echo=TRUE}
cor_test_result <- cor.test(bicycle_rent_clean_fix_f2$cnt, bicycle_rent_clean_fix_f2$temp, method = "pearson")
```

Таким образом, на основании корреляционного анализа мы можем заключить, что верна альтернативная гипотеза и количество прокатов зависит от температуры (p-value = `r cor_test_result$p.value`, значение статистики `r cor_test_result$statistic` )

2)  Проверим гипотезу о росте популярности проката велосипедов и самокатов с 2011 по 2012 год. Для этого разобьем датасет на 2 года

    1)  Нулевая гипотеза: Нет значимого роста количества пользователей проката между 2011 и 2012 годами, то есть среднее количество пользователей за оба года одинаково Количество пользователей в 2012 году значительно больше, чем в 2011 году, то есть среднее количество пользователей за 2012 год больше, чем за 2011 год

    2)  Зафиксируем уровень значимости - 0.05

    3)  Используем Т-критерия Стьюдента для независимыз выборок

    4)  Рассчитаем статистику и p-value

```{r, echo=TRUE}
year_2011_bicycle_rent_clean <- bicycle_rent_clean_fix %>% filter(yr == 2011)
year_2012_bicycle_rent_clean <- bicycle_rent_clean_fix %>% filter(yr == 2012)

bicycle_rent_clean_fix <-  bicycle_rent_clean_fix %>%
  mutate(yr = as.numeric(yr))


t_test_result <- t.test(year_2011_bicycle_rent_clean$registered,   year_2012_bicycle_rent_clean$registered)
bicycle_rent_clean_fix <-  bicycle_rent_clean_fix %>%
  mutate(yr = as.numeric(yr))
test_result <-  t.test(year_2011_bicycle_rent_clean$registered,   year_2012_bicycle_rent_clean$registered)
```

На основании двухстороннего двухвыборочного Т-критерия Стьюдента мы можем заключить, что в 2012 году прокат велосипедов стал популярнее в сравнении с 2011 годом. p-value составил `r test_result$p.value`, статистика t = `r test_result$statistic`

3)  Проверим гипотезу о зависимости состояния погоды и количества прокатов. Нулевая гипотеза: Распределение количества прокатов по различным состояниям погоды одинаково. Альтернативная гипотеза: Распределение количества прокатов по различным состояниям погоды отличается. Создадим таблицу сопряженности для проверки связи между состоянием погоды `weathersit` и тем, превышает ли количество прокатов `cnt` медианное значение.

```{r, echo=TRUE, message=TRUE}
table(bicycle_rent_clean_fix_f2$weathersit, bicycle_rent_clean_fix_f2$cnt > median(bicycle_rent_clean_fix_f2$cnt))
chisq_result <-  chisq.test(table(bicycle_rent_clean_fix_f2$weathersit, bicycle_rent_clean_fix_f2$cnt > median(bicycle_rent_clean_fix_f2$cnt)))
chisq_result
```

В колонке TRUE записано количество прокатов, превышающих медианное значение для трех состояний погды. В FALSE количество, не превышающее медианное значение. Таким образом, стостояние погоды действительно влияет на количество прокатов (p-value: `r chisq_result$p.value`, X-squared:`r chisq_result$statistic`)

```         
1)  Проверим еще одну гипотезу: есть ли различия в количестве прокатов в рабочие и выходные дни.
2)  Будем использовать непараметрический критерий Манна-Уитни.
3)  Уровень значимости зададим 0.05
4)  Нулевая гипотеза: распределение количества прокатов одинаково в рабочие и нерабочие дни. Альтернативная гипотеза: Распределение количества прокатов отличается в рабочие и нерабочие дни.
5)  Считаем статистику
```

```{r, echo=TRUE}
mann_whitney_test <- wilcox.test(cnt ~ workingday, data = bicycle_rent_clean_fix_f2)
mann_whitney_test
```

Таким образом верна нулевая гипотеза и распределение количества прокатов не отличается в рабочие и нерабочие дни. p.value = `r mann_whitney_test$p.value`, статистика = `r mann_whitney_test$statistic`

Теперь попробуем посмотреть насколько много арендуют велосипеды летом и весной. Различаются ли данные выборки в обоих годах?

Для начала отфильтруем интересные нам данные и проверим их на нормальность, чтобы понять какой тест мы можем применить.

```{r, echo=TRUE}
spring_bicycle_rent_clean <- bicycle_rent_clean_fix_f2 %>% filter(season == 2)
summer_bicycle_rent_clean <- bicycle_rent_clean_fix_f2 %>% filter(season == 3)
shapiro.test(season_spring_bicycle_rent_clean$cnt)
shapiro.test(season_summer_bicycle_rent_clean$cnt)

```

Пу-пу-пу-пууууу.... Похоже в соответствии с нашими расчётами можно сделать вывод о том, что данные в нашей выборки взяты из генеральной совокупности с ненормальным распределением, т.к. значение p value меньше заданного уровня значимости 0,05.

```{r, echo=TRUE}
season_bicycle_rent_clean <- bicycle_rent_clean_fix_f2 %>% filter(season == 2 | season == 3)
ggplot(season_bicycle_rent_clean, aes(x = cnt, color = as.factor(season))) +
  geom_density() +
  labs(title = "Плотность аренды велосипедов по сезонам",
       x = "Количество арендованных велосипедов",
       y = "Плотность",
       color = "Сезон") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
```

Однако нельзя забывать, что мы уже заметили некоторый прирост пользователей в 2012 году по сравнению с 2011. Чтож, давайте попробуем разделить их по годам и посмотреть, что получится.

```{r, echo=TRUE}
year_2011_bicycle_rent_clean <- season_bicycle_rent_clean %>% filter(yr == 2011)
year_2012_bicycle_rent_clean <- season_bicycle_rent_clean %>% filter(yr == 2012)
ggplot(season_bicycle_rent_clean, aes(x = cnt, color = interaction(as.factor(season), yr))) +
  geom_density() +
  labs(title = "Плотность аренды велосипедов по годам весной и летом",
       x = "Количество арендованных велосипедов",
       y = "Плотность",
       color = "Сезон") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
```

На данном графике это прекрасно видно. Давайте выберем для сравнения 2012 год.

1)  Определим нулевую и альтернативные гипотезы - величины распределены одинаково распределение величин отличается.

2)  Зафиксируем уровень значимости - 0.05

3)  Выберем для независимых выборок непараметрический критерий Манна-Уитни, т.к. распределение ненормальное.

    ```{r}
    spring_bicycle_rent_clean_2012 <- season_bicycle_rent_clean %>% filter(yr == 2012)
    summer_bicycle_rent_clean_2012 <- season_bicycle_rent_clean %>% filter(yr == 2012)
    shapiro.test(spring_bicycle_rent_clean_2012$cnt)
    shapiro.test(summer_bicycle_rent_clean_2012$cnt)
    ```

4)  Считаем статистику

    ```{r}
    wilcox.test(spring_bicycle_rent_clean_2012$cnt, summer_bicycle_rent_clean_2012$cnt, correct = F)
    #t_stat_season <- t.test(spring_bicycle_rent_clean_2012$cnt, summer_bicycle_rent_clean_2012$cnt, paired = FALSE)
    #t_stat_season
    ```

5)  Согласно тесту наши выборки достоверно отличаются, на основании чего мы можем сказать, что летом спрос на велосипеды выше.
